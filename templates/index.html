<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Huawei Switch Backup System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .log-entry { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .progress-bar { transition: width 0.3s ease; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
      <!-- Header -->
      <div class="bg-gradient-to-r from-blue-600 to-blue-800 px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <i class="fas fa-server text-white text-2xl"></i>
            <h1 class="text-2xl font-bold text-white">Huawei Switch Backup</h1>
          </div>
          <span class="bg-blue-500 text-white text-xs font-semibold px-2.5 py-0.5 rounded-full">v2.1.1</span>
        </div>
      </div>

      <!-- Main Content -->
      <div class="p-6">
        <div class="mb-6">
          <div class="flex items-center mb-2">
            <i class="fas fa-info-circle text-blue-500 mr-2"></i>
            <h2 class="text-lg font-semibold text-gray-800">Backup Configuration</h2>
          </div>
          <p class="text-gray-600 mb-4">Press the button below to backup all switches from <code class="bg-gray-100 px-2 py-1 rounded text-blue-600">switches.csv</code>. Passwords will be encrypted automatically during the process.</p>

          <div class="flex flex-col sm:flex-row sm:items-center gap-4 mb-6">
            <button id="backupBtn" type="button"
                    class="flex items-center justify-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-sm transition-colors duration-200">
              <i class="fas fa-download mr-2"></i> Run Backup Now
            </button>

            <div class="flex-1">
              <div class="flex justify-between text-sm text-gray-600 mb-1">
                <span>Progress</span>
                <span id="progressText">0%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progressBar" class="progress-bar bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Log Section -->
        <div>
          <div class="flex items-center mb-3">
            <i class="fas fa-terminal text-blue-500 mr-2"></i>
            <h2 class="text-lg font-semibold text-gray-800">Backup Logs</h2>
            <span id="logCount" class="ml-auto bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded-full">0 items</span>
          </div>

          <div id="logContainer" class="bg-gray-900 rounded-lg p-4 font-mono text-sm text-green-300 h-64 overflow-y-auto">
            <div id="logPlaceholder" class="text-gray-500 italic">Waiting for backup to start...</div>
          </div>

          <div class="mt-3 flex justify-between items-center text-sm text-gray-500">
            <div>
              <i class="fas fa-clock mr-1"></i>
              <span id="lastBackupTime">Never backed up</span>
            </div>
            <button id="clearLogsBtn" class="text-gray-500 hover:text-gray-700">
              <i class="fas fa-trash-alt mr-1"></i> Clear Logs
            </button>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between text-sm text-gray-500">
          <div class="mb-2 md:mb-0">
            <i class="fas fa-shield-alt mr-1"></i> All backups are encrypted using AES-256
          </div>
          <div>
            <i class="fas fa-history mr-1"></i> Last system update: 2023-11-15
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const backupBtn = document.getElementById('backupBtn');
      const clearLogsBtn = document.getElementById('clearLogsBtn');
      const logContainer = document.getElementById('logContainer');
      const logPlaceholder = document.getElementById('logPlaceholder');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const logCount = document.getElementById('logCount');
      const lastBackupTime = document.getElementById('lastBackupTime');

      let logEntries = 0;
      let backupInProgress = false;

      backupBtn.addEventListener('click', async function() {
        if (backupInProgress) {
          addLogEntry("Backup already in progress", "warning");
          return;
        }

        backupInProgress = true;
        backupBtn.disabled = true;
        backupBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        backupBtn.classList.add('bg-blue-400', 'cursor-not-allowed');

        clearLogs();
        addLogEntry("Sending backup request to server...", "info");

        try {
          const response = await fetch("/run-backup", { method: "POST" });
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const data = await response.json();

          // Simulate logs for each switch (frontend simulation)
          const switches = data.switches || [];
          let completed = 0;
          const total = switches.length;

          for (const sw of switches) {
            await new Promise(r => setTimeout(r, 400)); // simulate connection
            addLogEntry(`Successfully connected to ${sw.hostname} (${sw.ip})`, "success");
            await new Promise(r => setTimeout(r, 300)); // simulate backup
            addLogEntry(`Backup completed for ${sw.hostname}`, "success");
            completed++;
            const progress = Math.round((completed / total) * 100);
            updateProgress(progress);
          }

          addLogEntry(data.message || "Backup completed successfully", "success");
          updateProgress(100);
          lastBackupTime.textContent = new Date().toLocaleString();

        } catch (error) {
          console.error(error);
          addLogEntry("Failed to contact server or backup error", "error");
        } finally {
          backupInProgress = false;
          backupBtn.disabled = false;
          backupBtn.classList.remove('bg-blue-400', 'cursor-not-allowed');
          backupBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }
      });

      clearLogsBtn.addEventListener('click', function() {
        if (!backupInProgress) clearLogs();
        else addLogEntry("Cannot clear logs during backup operation", "error");
      });

      function clearLogs() {
        logContainer.innerHTML = '<div id="logPlaceholder" class="text-gray-500 italic">Logs cleared</div>';
        logEntries = 0;
        updateLogCount();
      }

      function addLogEntry(message, type) {
        if (logPlaceholder) logPlaceholder.remove();
        const entry = document.createElement('div');
        entry.className = 'log-entry mb-2';

        let icon, color;
        switch(type) {
          case 'error': icon='fas fa-times-circle'; color='text-red-400'; break;
          case 'warning': icon='fas fa-exclamation-triangle'; color='text-yellow-400'; break;
          case 'success': icon='fas fa-check-circle'; color='text-green-400'; break;
          default: icon='fas fa-info-circle'; color='text-blue-400';
        }

        const timestamp = new Date().toLocaleTimeString();
        entry.innerHTML = `<span class="text-gray-500 mr-2">[${timestamp}]</span>
                           <i class="${icon} ${color} mr-2"></i>${message}`;
        logContainer.appendChild(entry);
        logContainer.scrollTop = logContainer.scrollHeight;
        logEntries++;
        updateLogCount();
      }

      function updateProgress(percent) {
        progressBar.style.width = `${percent}%`;
        progressText.textContent = `${percent}%`;
      }

      function updateLogCount() {
        logCount.textContent = `${logEntries} ${logEntries === 1 ? 'item' : 'items'}`;
      }
    });
  </script>
</body>
</html>
